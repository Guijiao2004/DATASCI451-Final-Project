---
title: "DATASCI451_Final_Project"
output: pdf_document
date: "2025-04-08"
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

```{r}
library(dplyr)
library(ggplot2)
library(rstan)
options(mc.cores = 4)
```


```{r}
olympics <- read.csv('01_data_preprocessing/data/olympics.csv')
head(olympics)

olympics$log_X.Athletes <- log(olympics$X.Athletes + 1)
olympics$log_X.Events <- log(olympics$X.Events + 1)
```

```{r}
medals_by_country <- olympics |>
  group_by(NOC) |>
  summarise(Total = sum(Total)) |>
  arrange(desc(Total))

head(medals_by_country)

# Bar plot
ggplot(medals_by_country, aes(x = reorder(NOC, -Total), y = Total)) +
  geom_col(fill = "blue") +
  labs(title = "Total Medals by Country", x = "Country")
```
```{r}
olympics |>
  group_by(Year) |>
  summarise(Total = sum(Total)) |>
  ggplot(aes(x = Year, y = Total)) +
  geom_line() +
  labs(title = "Global Medal Trend Over Time")


olympics |>
  filter(NOC == "AUS") |>
  ggplot(aes(x = Year, y = Total)) +
  geom_line() +
  labs(title = "Australia's Medal Trend")
```
```{r}
olympics |>
  group_by(IsHost) |>
  summarise(Avg_Total = mean(Total)) |>
  ggplot(aes(x = factor(IsHost), y = Avg_Total)) +
  geom_col() +
  labs(title = "Host vs Non-Host medals", x = "Host? (0=No, 1=Yes)")
```
```{r}
olympics |>
  group_by(NOC) |>
  summarise(Gold = sum(Gold), Silver = sum(Silver), Bronze = sum(Bronze)) |>
  tidyr::pivot_longer(cols = c(Gold, Silver, Bronze)) |>
  ggplot(aes(x = reorder(NOC, -value), y = value, fill = name)) +
  geom_col() +
  labs(title = "Medal Type Distribution by Country", x = "Country")
```
```{r}
ggplot(olympics, aes(x = X.Athletes, y = Total)) +
  geom_point() +
  geom_smooth(method = "lm") +
  labs(title = "Athletes vs Total Medals")

cor(olympics$X.Athletes, olympics$Total, use = "complete.obs")
```
```{r}
# Histogram for each # events, 

hist(olympics$X.Events)


```
```{r}
hist(olympics$X.Athletes)
```
```{r}
hist(olympics$Total)
mean(olympics$Total)
var(olympics$Total)
```
```{r}
hist(olympics$Gold)
mean(olympics$Gold)
var(olympics$Gold)
```
```{r}
hist(olympics$Silver)
mean(olympics$Silver)
var(olympics$Silver)
```
```{r}
hist(olympics$Bronze)
mean(olympics$Bronze)
var(olympics$Bronze)
```

$$
\text{Total}_{c, y}\sim\text{Poisson}(\lambda_{c, y})
$$
$$
\log(\lambda_{c, y}) = \alpha_c + \beta_0 + \beta_1\text{X.Athletes}_{c, y} + \beta_2\text{X.Events}_{c, y} + \beta_3\text{IsHost}_{c, y}
$$
$$
\alpha_c \sim N(0, \sigma_{\alpha}^2) \\
\beta_i \sim N(0, \sigma_{i}^2) \text{ for } i = 0, 1, 2, 3, 4
$$
```{r}
stan_model_code <- "
data {
  int<lower=0> N; // number of observations
  int<lower=0> C; // number of countries
  int<lower=0> Y; // number of years
  array[C, Y] int<lower=0> Total; // total medals
  array[C, Y] real<lower=0> N_athletes; // number of athletes
  array[C, Y] real<lower=0> N_events; // number of events
  array[C, Y] int<lower=0, upper=1> IsHost; // host country
}
parameters {
  array[C] real alpha; // country-specific intercepts
  array[4] real beta; // coefficients for predictors
  real<lower=0> phi; // dispersion parameter
}
model {
  for (c in 1:C) {
    for (y in 1:Y) {
      Total[c, y] ~ neg_binomial_2_log(alpha[c] + beta[1] + beta[2] * N_athletes[c, y] + beta[3] * N_events[c, y] + beta[4] * IsHost[c, y], phi);
    }
  }
  
  // Priors
  alpha ~ normal(0, 5);
  phi ~ gamma(2, 0.1);
  for (i in 1:4) {
    beta[i] ~ normal(0, 5);
  }
}

"
```

```{r}
N = nrow(olympics)
C = length(unique(olympics$NOC))
Y = max(olympics$Year)
Total = matrix(0, nrow = C, ncol = Y)
N_athletes = matrix(0, nrow = C, ncol = Y)
N_events = matrix(0, nrow = C, ncol = Y)
IsHost = matrix(0, nrow = C, ncol = Y)
for (i in 1:C) {
  country_data = olympics[olympics$Country == i, ]
  for (j in 1:Y) {
    year_data = country_data[country_data$Year == j, ]
    if (nrow(year_data) > 0) {
      Total[i, j] = year_data$Gold
      N_athletes[i, j] = year_data$log_X.Athletes
      N_events[i, j] = year_data$log_X.Events
      IsHost[i, j] = year_data$IsHost
    }
  }
}

data_list = list(
  N = N,
  C = C,
  Y = Y,
  Total = Total,
  N_athletes = N_athletes,
  N_events = N_events,
  IsHost = IsHost
)
```


```{r}
model = stan_model(model_code = stan_model_code)

fit <- sampling(object = model, 
            data = data_list, 
            iter = 10000,
            warmup = 2000, 
            seed = 451)
```

```{r}
plot(fit)
```
```{r}
stan_trace(fit, nrow = 3, ncol = 4)
```

```{r}
stan_hist(fit)
```

```{r}
# Summary of the model
summary(fit)$summary
```

```{r}
# Predict the number of medals for 2028
new_data <- data.frame(
  NOC = "USA",
  Year = 34,
  X.Athletes = 856, # How many athletes?
  X.Events = 245, # How many events?
  IsHost = 1,
  Country = 1,
  log_X.Athletes = log(856 + 1),
  log_X.Events = log(245 + 1)
)
```

```{r}
# Extract posterior samples
posterior_samples <- extract(fit)
alpha_samples <- posterior_samples$alpha[, 1]    # vector of MCMC samples for alpha[c]
beta_samples  <- posterior_samples$beta          # matrix: iterations Ã— 4 (or list of vectors)
phi_samples   <- posterior_samples$phi     # vector of MCMC samples for phi

# Calculate log(lambda)
log_lambda <- alpha_samples +
              beta_samples[,1] +
              beta_samples[,2] * new_data$log_X.Athletes +
              beta_samples[,3] * new_data$log_X.Events +
              beta_samples[,4] * new_data$IsHost

# Calculate lambda
lambda_pred <- exp(log_lambda)

# Generate predictions from Poisson distribution
set.seed(451)  # for reproducibility
total_pred <- rnbinom(n = length(lambda_pred), 
                       size = phi_samples, 
                       mu = lambda_pred)
```

```{r}
# Visualize predictions
summary(total_pred)
hist(lambda_pred)
hist(total_pred)
```